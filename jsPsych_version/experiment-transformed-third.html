<!DOCTYPE html>

<html>

<head>
  <title>Stop Signal Task</title>

  <!-- Load jsPsych & Dependencies -->
  <script src="js/jquery-1.7.1.min.js"></script> 
  <script src="js/jspsych-6.0.5/jspsych.js"></script>
  <script src="js/jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
  <script src="js/jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
  <script src="js/jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
  <script src="js/jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="js/jspsych-detect-held-down-keys.js"></script> 
  <script src="js/custom-stop-signal-plugin.js"></script>
  <script src="js/sprintf.js"></script> 
  <script src="configuration/experiment_variables.js"></script> 
  <script src="configuration/text_variables.js"></script>
  <script src="stop-it_main.js"></script>

  <link href="js/jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css">
</head>

<body>
  <div id='display_stage_background'></div>
  <div id='display_stage'></div>
</body>

<script>

  // ‚úÖ Ensure `urlParams` is only defined once globally
if (!window.hasOwnProperty("urlParams")) {  
    window.urlParams = new URLSearchParams(window.location.search);
    window.participantId = window.urlParams.get("participantId") || "guest_" + Date.now();
    console.log("‚úÖ Assigned Participant ID:", window.participantId);
}

// ‚úÖ Use participantId safely throughout the script
var participantId = window.participantId;



  /* ‚úÖ Helper function to filter data before saving */
  function filter_data() {
    var ignore_columns = ['raw_rt', 'trial_type', 'first_stimulus', 'second_stimulus', 'onset_of_first_stimulus',
      'onset_of_second_stimulus', 'key_press', 'correct_response', 'trial_index', 'internal_node_id'
    ];
    
    var rows = { trial_type: 'custom-stop-signal-plugin' };
    var selected_data = jsPsych.data.get().filter(rows).ignore(ignore_columns);
    var d = selected_data.values(); // Get trial data

    // Define column order
    var arr = ['participant_id', 'block_i', 'trial_i', 'stim', 'signal', 'SSD', 'response', 'rt', 'correct',
      'focus', 'Fullscreen', 'time_elapsed', 'window_resolution'];

    new_arr = []; // Array for formatted data

    for (var i = 0; i < d.length; i++) {
        var obj = d[i]; // Get one trial's data
        var new_obj = { participant_id: participantId }; // Include participant ID

        arr.forEach(function(item) { 
            new_obj[item] = obj[item]; 
        });

        new_arr.push(new_obj); // Store formatted trial data
    }

    return new_arr; // Return structured data
}
  
  /* ‚úÖ Define function to save data via fetch API */
  function saveStopITData() {
    console.log("‚úÖ Saving STOP-IT Data...");

    var requestBody = filter_data(); // Extract filtered data
    console.log("üìä Filtered STOP-IT Data:", requestBody);
    
    // Convert to CSV if needed
    var csvData = jsPsych.data.get().csv();

    fetch("https://DecisionLab.eu.pythonanywhere.com/save-stopit-response", {
        method: "POST",
        headers: { "Content-Type": "application/json" }, // Change to "text/csv" if needed
        body: JSON.stringify({ 
            participant_id: participantId, 
            data: csvData // Sending CSV instead of JSON object
        })
    })
    .then(response => response.text())
    .then(data => console.log("‚úÖ Server Response:", data))
    .catch(error => console.error("‚ùå Error saving STOP-IT response:", error));
}

  /* ‚úÖ Define Experiment */
  var task_id = "STOP-IT";
  var sbj_id = participantId; 

  var timeline = [];
  timeline.push(start_procedure, block_procedure, end_procedure);

  /* ‚úÖ Run the Experiment */
  jsPsych.init({
    display_element: 'display_stage',
    timeline: timeline,
    preload_images: [fix_stim, go_stim1, go_stim2, stop_stim1, stop_stim2],

    on_data_update: function (data) {
      data.window_resolution = window.innerWidth + ' x ' + window.innerHeight;
      data.focus = focus;
      data.Fullscreen = fullscr_ON;
    },

    on_interaction_data_update: function (data) {
      interaction = data.event;
      if (interaction.includes("fullscreen")) {
        fullscr_ON = (fullscr_ON === 'no') ? 'yes' : 'no';
      } else if (interaction === 'blur' || interaction === 'focus') {
        focus = interaction;
      }
    },

    exclusions: {
      min_width: minWidth,
      min_height: minHeight
    },

    /* ‚úÖ Sending results upon completion */
    on_finish: function () {
      console.log("‚úÖ Experiment finished, calling saveStopITData()");
      saveStopITData();
    }  // ‚úÖ Removed the misplaced comma here
  });

</script>

</html>


